const webtaskApi = module.webtask;
module.exports=function(e){var t={};function r(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(o,s,function(t){return e[t]}.bind(null,s));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/build/",r(r.s="./build/webtask/sync-stories.js")}({"./build/src/models/article.js":function(e,t,r){"use strict";r.r(t),r.d(t,"Article",function(){return o});r("./node_modules/core-js/modules/es6.array.sort.js");(e=e||{}).webtask=webtaskApi;class o{get url(){return this._id}set url(e){this._id=e.replace(/\/+$/,"")}static deserializeFromDate(e){return e?e instanceof Date?e:e.$date?new Date(e.$date):new Date(e):null}static fromDumbJson(e){let t=new o;if(e.url=e.url||e._id||e.objectID,!e.url)throw"url is empty while creating story from dumbjson";return t.url=e.url.trim(),t.domain=e.domain||o.extractHostname(t.url),t.source=e.source,t.sourceTopic=e.sourceTopic,t.sourceCountry=e.sourceCountry,t.title=e.title,t.description=e.description,o.isUrl(e.urlToImage)&&(t.urlToImage=e.urlToImage),o.isUrl(e.urlToVideo)&&(t.urlToVideo=e.urlToVideo),t.author=e.author,t.publishedAt=o.deserializeFromDate(e.publishedAt),t.htmlBody=e.htmlBody,t.summary=e.summary,t.originalWordCount=e.originalWordCount,t.summaryWordCount=e.summaryWordCount,t.createdAt=o.deserializeFromDate(e.createdAt),t.sharingLink=e.sharingLink,e.relatedStories&&(t.relatedStories=e.relatedStories.map(e=>o.minStoryFromDumbJson(e))),t.flag=e.flag,t.highlights=e.highlights,t.entities=e.entities,t.language=e.language,t.sentimentScore=e.sentimentScore,t.tags=e.tags||e._tags,t}isTitleImportant(){return!!this.title.match(/live|disaster|suspect|struck|trash|incident|final|leak|odi|strike|kill|crash|dead|die|prize|win|winner|won|lift|triumph|lose|lost|breaking|fire|terror|attack|bomb|blast|war|result|exam/i)}static minStoryFromDumbJson(e){return{url:e.url,title:e.title,urlToImage:e.urlToImage,createdAt:new Date(e.createdAt),simScore:e.simScore,domain:e.domain||o.extractHostname(e.url)}}isPublishedAfter(e){let t=this.publishedAt||this.createdAt,r=e.publishedAt||e.createdAt;return t.getTime()-r.getTime()>0}static normalizeUrl(e){return e.replace(/^(http:\/\/|https:\/\/)/,"").replace(/\/+$/,"")}static compareUrls(e,t){return this.normalizeUrl(e)==this.normalizeUrl(t)}static isUrl(e){return null!=e&&(e.toLowerCase().startsWith("https://")||e.toLowerCase().startsWith("http://")||e.toLowerCase().startsWith("//"))}static isImageUrl(e){return null!=e&&null!=e.match(/\.(jpeg|jpg|gif|png)$/i)}static isGIF(e){return null!=e&&null!=e.match(/\.(gif)$/i)}static extractHostname(e){if(!e)return null;let t;return(t=(t=(t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split(":")[0]).split("?")[0])&&t.startsWith("www.")&&(t=t.replace("www.","")),t}static buildNewsmakers(e){let t=[].concat.apply([],e.filter(e=>e.entities).map(e=>e.entities)).map(e=>e.name),r=[].concat.apply([],e.filter(e=>e.tags).map(e=>e.tags)).filter(e=>e.length<20),o={};return t.forEach(e=>o[e]=o[e]?o[e]+1:1),r.forEach(e=>o[e]=o[e]?o[e]+1:1),Object.keys(o).map(e=>({tag:e,count:o[e]})).sort((e,t)=>t.count>e.count?1:-1).slice(0,10)}}},"./build/src/models/filter.js":function(e,t,r){"use strict";r.r(t),r.d(t,"Filter",function(){return o}),(e=e||{}).webtask=webtaskApi;class o{static isValidType(e){return o.ALL_TYPES.indexOf(e)>-1}static fromEntity(e){return o.fromJson({type:o.FILTER_TYPE_ENTITY,term:e})}static fromChannel(e){return o.fromJson({type:o.FILTER_TYPE_CHANNEL,term:e})}static fromTopic(e){return o.fromJson({type:o.FILTER_TYPE_TOPIC,term:e})}static fromJson(e){if("string"==typeof e)return o.fromString(e);{let t=new o;return t.term=e.term,t.type=e.type,t}}static fromString(e){let t=new o;t.type=o.FILTER_TYPE_TOPIC,e.startsWith("source:")&&(e=e.replace("source:","channel:"));let r=e.indexOf(":");if(r>-1){let s=e.substring(0,r);if(!o.isValidType(s))return null;t.type=s,t.term=decodeURIComponent(e.substring(r+1))}else"all"!=e&&"top"!=e&&"bookmarks"!=e||(t.type=o.FILTER_TYPE_SPECIAL),t.term=e;return t}isTopStoriesFilter(){return this.type==o.FILTER_TYPE_SPECIAL&&"top"===this.term}isBookmarksFilter(){return this.type==o.FILTER_TYPE_SPECIAL&&"bookmarks"===this.term}isVideosFilter(){return this.type==o.FILTER_TYPE_SPECIAL&&"videos"===this.term}isAllSubscriptionsFilter(){return this.type==o.FILTER_TYPE_SPECIAL&&"all"===this.term}isSpecial(){return this.type==o.FILTER_TYPE_SPECIAL}isTopic(){return this.type==o.FILTER_TYPE_TOPIC}isChannel(){return this.type==o.FILTER_TYPE_CHANNEL}isHasSource(){return this.isTopic()||this.isChannel()||this.isSpecial()}isSearch(){return this.type==o.FILTER_TYPE_SEARCH_STRING}isEntity(){return this.type==o.FILTER_TYPE_ENTITY}isTag(){return this.type==o.FILTER_TYPE_TAG}toString(){return`${this.type}:${encodeURIComponent(this.term)}`}isEquals(e){return console.debug("[filter] isEquals called"),null!=e&&(this.type==e.type&&this.term==e.term)}getChannelIds(e,t){if(this.isChannel())return[this.term];if(e){if(this.isTopStoriesFilter())return this.getTopChannels(e,t);if(this.isTopic()||this.isAllSubscriptionsFilter())return e.getSubscribedSources(this.term)||[]}return null}getChannelCount(e){return this.isChannel()||this.isTopStoriesFilter()?1:this.isTopic()||this.isAllSubscriptionsFilter()?e.getSubscribedCount(this.term):0}getTopChannels(e,t){let r=e.get("countryCode")||"ww";return t?t.getJSONProp("top_feed_sources")[r]:[]}getHotTierSearchParams(e,t,r){let s=e?e.get("countryCode"):r,i="language:'en'";s&&(i+=` AND (sourceCountry:${s} OR sourceCountry:ww)`);let n="",l=null,a=this.getChannelIds(e,t);return a&&a.length>0?i=`(${a.map(e=>"source:"+e).join(" OR ")}) `:this.type==o.FILTER_TYPE_CHANNEL?i+=`AND (entities.commonname:'${this.term}') `:this.type==o.FILTER_TYPE_ENTITY?i+=`AND (entities.commonname:'${this.term}') `:this.type==o.FILTER_TYPE_TAG?i+=`AND (_tags:'${this.term}') `:this.type==o.FILTER_TYPE_SEARCH_STRING?(n=`"${this.term}"`,i+="",l={advancedSyntax:!0,queryType:"prefixNone",typoTolerance:!1,restrictSearchableAttributes:["title","description"]}):this.isEquals(o.FILTER_SPECIAL_VIDEOS)&&(i+=" AND (hasVideo: true)"),{searchString:n,filterString:i,extraParams:l}}}o.FILTER_TYPE_SPECIAL="special",o.FILTER_TYPE_TOPIC="topic",o.FILTER_TYPE_CHANNEL="channel",o.FILTER_TYPE_ENTITY="entity",o.FILTER_TYPE_TAG="tag",o.FILTER_TYPE_SEARCH_STRING="search-string",o.ALL_TYPES=[o.FILTER_TYPE_SPECIAL,o.FILTER_TYPE_TOPIC,o.FILTER_TYPE_CHANNEL,o.FILTER_TYPE_ENTITY,o.FILTER_TYPE_TAG,o.FILTER_TYPE_SEARCH_STRING],o.FILTER_SPECIAL_ALL=o.fromJson({type:o.FILTER_TYPE_SPECIAL,term:"all"}),o.FILTER_SPECIAL_BOOKMARKS=o.fromJson({type:o.FILTER_TYPE_SPECIAL,term:"bookmarks"}),o.FILTER_SPECIAL_TOP=o.fromJson({type:o.FILTER_TYPE_SPECIAL,term:"top"}),o.FILTER_SPECIAL_VIDEOS=o.fromJson({type:o.FILTER_TYPE_SPECIAL,term:"videos"}),o.ALL_SPECIAL_FILTERS=[o.FILTER_SPECIAL_ALL,o.FILTER_SPECIAL_BOOKMARKS,o.FILTER_SPECIAL_TOP,o.FILTER_SPECIAL_VIDEOS]},"./build/src/models/source.js":function(e,t,r){"use strict";r.r(t),r.d(t,"Source",function(){return o}),(e=e||{}).webtask=webtaskApi;class o{constructor(){this.detailsProvider=o.DETAILS_PROVIDER_MERCURY}static fromJson(e){let t=new o;return t.id=e.id||e._id,t.aggregator=e.aggregator,t.aggregatorSource=e.aggregatorSource,t.category=e.category,t.name=e.name,t.country=e.country,t.badge=e.badge,t.detailsProvider=e.detailsProvider,t.language=e.language,t.ratePerWeek=e.ratePerWeek,t.url=e.url,t.disabled=e.disabled,t.inTesting=e.inTesting,t.desc=e.desc,t.redirectSource=e.redirectSource,t.tags=e.tags,t.multiLanguage=e.multiLanguage,t}static isPrimaryVideo(e){return e.tags&&e.tags.indexOf("primary-video")>-1}static isPrimaryImage(e){return e.tags&&e.tags.indexOf("primary-image")>-1}}o.AGGREGATOR_REDDIT="reddit",o.AGGREGATOR_YT="youtube",o.AGGREGATOR_TWITTER="twitter",o.AGGREGATOR_NEWSAPI="newsapi",o.AGGREGATOR_1R="1r",o.AGGREGATOR_NEWZCONE="newzcone",o.AGGREGATOR_MISCAPI="misc-api",o.AGGREGATOR_SCRAPER="scraper",o.DETAILS_PROVIDER_MERCURY="mercury",o.DETAILS_PROVIDER_SCRAPER="scraper",o.DETAILS_PROVIDER_SCRAPER_UNFLUFF="scraper_unfluff",o.DETAILS_PROVIDER_NONE="none"},"./build/src/models/trend.js":function(e,t,r){"use strict";r.r(t),r.d(t,"Trend",function(){return s});var o=r("./build/src/models/filter.js");(e=e||{}).webtask=webtaskApi;class s{getFilter(){return o.Filter.fromJson({term:this.term,type:this.type})}static fromJson(e){let t=new s;return t.term=e.term,t.type=e.type,t.state=e.state||"ToBeProcessed",t.horizon=e.horizon,t.source=e.source,t.countryCode=e.countryCode,t.sourceSpecificPopularity=e.sourceSpecificPopularity,t.storyCount=e.storyCount,t.refStoryList=e.refStoryList,t.topStoryList=e.topStoryList,t.features=e.features,t.relatedTerms=e.relatedTerms,e.createdAt&&(t.createdAt=new Date(e.createdAt)),e.lastUpdatedAt&&(t.lastUpdatedAt=new Date(e.lastUpdatedAt)),e.validTill&&(t.validTill=new Date(e.validTill)),t}static fromTwitterTrend(e,t){let r=new s;return r.term=e.name,r.type=o.Filter.FILTER_TYPE_SEARCH_STRING,r.state="ToBeProcessed",r.horizon="hour",r.source="twitter",r.sourceSpecificPopularity=e.twitter_volume,r.countryCode=t,r}static fromGoogleTrend(e,t){let r=new s;return r.term=e.title,r.state="ToBeProcessed",r.type=o.Filter.FILTER_TYPE_SEARCH_STRING,r.horizon="hour",r.source="google",r.sourceSpecificPopularity=e.trafficBucketLowerBound,r.countryCode=t,e.newsArticlesList&&(r.refStoryList=e.newsArticlesList.map(e=>({url:e.link,title:e.title,desc:e.snippet}))),r}getHotTierSearchParams(){return this.getFilter().getHotTierSearchParams(null,null,this.countryCode)}}},"./build/webtask/base-database.js":function(e,t,r){"use strict";r.r(t),r.d(t,"BaseDatabase",function(){return n});r("./node_modules/core-js/modules/es6.array.sort.js");var o=r("rx"),s=r.n(o),i=r("mongodb");(e=e||{}).webtask=webtaskApi;class n{constructor(e){this.secrets=e}getDb(){if(global.db)return console.log("returning cached db connection"),s.a.Observable.of(global.db);let e=`mongodb://rw:${this.secrets.mlab_rw_password}@ds145952.mlab.com:45952/nooz`;return s.a.Observable.fromPromise(i.MongoClient.connect(e,{connectTimeoutMS:3e4,socketTimeoutMS:6e4})).map(e=>(global.db=e,e))}getLatestStoryCreatedTime(){return this.getDb().flatMap(e=>{let t=e.collection("story");return s.a.Observable.fromPromise(t.find({},{createdAt:1,_id:0}).sort({createdAt:-1}).limit(1).toArray()).map(e=>e?new Date(e[0].createdAt):null)})}getAllChannels(){return this.getDb().flatMap(e=>{let t=e.collection("channels");return s.a.Observable.fromPromise(t.find({}).toArray())})}getChannelById(e){return this.getDb().flatMap(t=>{let r=t.collection("channels");return s.a.Observable.fromPromise(r.findOne({_id:e}))})}getAllChannelsMeta(){return this.getDb().flatMap(e=>{let t=e.collection("jobs");return s.a.Observable.fromPromise(t.find({}).toArray())})}getDirtyChannels(){return this.getDb().flatMap(e=>{let t=e.collection("jobs");return s.a.Observable.fromPromise(t.find({dirty:!0}).toArray())})}getFreshChannels(){return this.getDb().flatMap(e=>{let t=e.collection("jobs");return s.a.Observable.fromPromise(t.find({dirty:!1}).toArray())})}markChannelDirty(e,t,r){return this.getDb().flatMap(o=>{let i=null;return i=t?{$set:{dirty:t,testUrl:r,lastDirtyAt:new Date}}:{$set:{dirty:t,lastVerifiedAt:new Date}},s.a.Observable.fromPromise(o.collection("jobs").updateOne({_id:e},i,{upsert:!0}).then(e=>e.result.ok?(console.log("response from db ok"),Promise.resolve(!0)):(console.log("response from db NOT ok: ",e),Promise.resolve(!1))))})}}},"./build/webtask/base-scraper.js":function(e,t,r){"use strict";r.r(t),r.d(t,"BaseScraper",function(){return u});var o=r("requestretry"),s=r.n(o),i=r("cloudscraper"),n=r.n(i),l=r("./build/webtask/scraper-config.js"),a=r("./build/src/models/article.js");(e=e||{}).webtask=webtaskApi;class u{constructor(){}static parseUrl(e,t){if(!e||!t)return null;let r=e.querySelector(t);return r?r.getAttribute("href")||r.getAttribute("src"):null}static parseDatetime(e,t){if(!e||!t)return null;let r=e.querySelector(t);return r?new Date(r.getAttribute("datetime")):null}static parseText(e,t){if(!e||!t)return null;let r=e.querySelector(t);return r?r.textContent:null}static parseHtml(e,t){if(!e||!t)return null;let r=e.querySelector(t);return r?r.innerHTML:null}getHtmlBody(e){let t=e.uri,r=a.Article.extractHostname(t);return l.ScraperConfig.protectedByCloudflare(r)?new Promise((e,r)=>{n.a.get(t,(t,o,s)=>{if(null!=t)return r(t);e(s)})}):(e.maxAttempts=2,e.retryDelay=500,e.fullResponse=!1,s()(e))}static toUrl(e,t){return e&&e.startsWith("/")?t+e:e}static extractPrefixUrl(e){if(!e)return null;let t;return(t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split("?")[0]}}},"./build/webtask/database.js":function(e,t,r){"use strict";r.r(t),r.d(t,"Database",function(){return a});r("./node_modules/core-js/modules/es6.array.sort.js");var o=r("rx"),s=r.n(o),i=r("./build/webtask/base-database.js"),n=r("./build/src/models/article.js"),l=r("./build/src/models/trend.js");(e=e||{}).webtask=webtaskApi;class a extends i.BaseDatabase{constructor(e){super(e)}getStoryByUrl(e){return this.getDb().flatMap(t=>{let r=t.collection("story");return s.a.Observable.fromPromise(r.findOne({_id:e})).map(e=>e?n.Article.fromDumbJson(e):null)})}getStories(e,t,r,o,i,l,a){let u={sourceTopic:{$in:o},source:{$in:r},createdAt:{$gte:e}};t&&(u={sourceTopic:{$in:o},source:{$in:r},createdAt:{$gte:e,$lt:t}}),r||delete u.source,o||delete u.sourceTopic;let c={createdAt:a?1:-1},d=i?{}:{summary:0},m=l?1e3:25;return this.getDb().flatMap(e=>{let t=e.collection("story");return s.a.Observable.fromPromise(t.find(u,d).sort(c).limit(m).toArray()).map(e=>e.map(e=>n.Article.fromDumbJson(e)))})}getMinStories(e,t){let r={createdAt:{$gte:e}},o={createdAt:-1};return this.getDb().flatMap(e=>{let i=e.collection("story");return s.a.Observable.fromPromise(i.find(r,t).sort(o).limit(1e3).toArray())})}unsetSummary(e){return this.getDb().flatMap(t=>s.a.Observable.fromPromise(t.collection("story").updateOne({_id:e},{$unset:{summary:1}})))}updateStoryWithRelatedStories(e,t){return this.getDb().flatMap(r=>s.a.Observable.fromPromise(r.collection("story").updateOne({_id:e},{$set:{relatedStories:t}}).then(e=>e.result.ok?(console.log("response from db ok"),Promise.resolve(!0)):(console.log("response from db NOT ok: ",e),Promise.resolve(!1)))))}getStoryUrls(e,t){console.log(`fetching old ${t} stories from db since ${e}`);let r={domain:{$in:t},createdAt:{$gte:e}},o={_id:1};return this.getDb().flatMap(e=>{let t=e.collection("story");return s.a.Observable.fromPromise(t.find(r,o).toArray()).map(e=>e.map(e=>e._id))})}getRelatedStories(e,t=4){let r={$text:{$search:e}},o={score:{$meta:"textScore"},title:1,urlToImage:1,createdAt:1},i={score:{$meta:"textScore"}};return this.getDb().flatMap(e=>{let n=e.collection("story");return s.a.Observable.fromPromise(n.find(r,o).sort(i).limit(t).toArray()).map(e=>e.map(e=>({url:e._id,title:e.title,urlToImage:e.urlToImage,createdAt:e.createdAt,simScore:1*e.score.toFixed(2)})))})}updateStoryWithSharingLink(e,t){return this.getDb().flatMap(r=>s.a.Observable.fromPromise(r.collection("story").updateOne({_id:e},{$set:{sharingLink:t}}).then(e=>e.result.ok?(console.log("response from db ok"),Promise.resolve(!0)):(console.log("response from db NOT ok: ",e),Promise.resolve(!1)))))}updateStoryWithEntitiesAndTags(e,t,r,o){let i={};return t&&(i.entities=t),r&&(i.tags=r),o&&(i.highlights=o),this.getDb().flatMap(t=>s.a.Observable.fromPromise(t.collection("story").updateOne({_id:e},{$set:i}).then(e=>e.result.ok?(console.log("response from db ok"),Promise.resolve(!0)):(console.log("response from db NOT ok: ",e),Promise.resolve(!1)))))}createStories(e){if(0==e.length)return s.a.Observable.of([]);let t=new Date;return e.forEach(e=>{e.createdAt=t,delete e.htmlBody}),this.getDb().flatMap(t=>s.a.Observable.fromPromise(t.collection("story").insertMany(e,{ordered:!1}).then(t=>t.result.ok?Promise.resolve(e):(console.log("response from db not ok: ",t),Promise.reject(t))).catch(t=>{let r=[];return t.errmsg||t.writeErrors?(t.writeErrors&&t.writeErrors.length>0?t.writeErrors.forEach(e=>{console.log("error insertMany errmsg:",e.errmsg),r.push(e.getOperation()._id)}):t.errmsg&&(console.log("error insertMany errmsg:",t.errmsg),r.push(t.getOperation()._id)),e=e.filter(e=>r.indexOf(e._id)<0),Promise.resolve(e)):(console.log("error insertMany:",t),Promise.reject(t))})))}createStory(e){return this.createStories([e])}createTrends(e){if(0==e.length)return s.a.Observable.of([]);let t=new Date;return e.forEach(e=>{e.createdAt=t,e.lastUpdatedAt=t}),this.getDb().flatMap(t=>s.a.Observable.fromPromise(t.collection("trends").insertMany(e,{ordered:!1}).then(t=>t.result.ok?Promise.resolve(e):(console.log("response from db not ok: ",t),Promise.reject(t))).catch(t=>{let r=[];return t.errmsg||t.writeErrors?(t.writeErrors&&t.writeErrors.length>0?t.writeErrors.forEach(e=>{console.log("error insertMany errmsg:",e.errmsg),r.push(e.getOperation().term)}):t.errmsg&&(console.log("error insertMany errmsg:",t.errmsg),r.push(t.getOperation().term)),e=e.filter(e=>r.indexOf(e.term)<0),Promise.resolve(e)):(console.log("error insertMany:",t),Promise.reject(t))})))}getTrendByTerm(e,t){let r={term:t,countryCode:e};return this.getDb().flatMap(e=>{let t=e.collection("trends");return s.a.Observable.fromPromise(t.find(r).collation({locale:"en",strength:1}).toArray()).map(e=>e&&e.length>0?l.Trend.fromJson(e[0]):null)})}getTrends(e,t,r){let o={state:{$in:t}};return e&&(o={state:{$in:t},countryCode:e}),console.log("[database][get-trends] query:",o),this.getDb().flatMap(e=>{let t=e.collection("trends");return s.a.Observable.fromPromise(t.find(o).sort({createdAt:-1}).limit(r).toArray()).map(e=>e.map(e=>l.Trend.fromJson(e)))})}updateTrends(e,t,r){if(0==t.length)return s.a.Observable.of([]);console.log(`[database][update-trends] updating ${t.length} terms with state ${r}`);let o=new Date;return this.getDb().flatMap(i=>s.a.Observable.fromPromise(i.collection("trends").updateMany({countryCode:e,term:{$in:t}},{$set:{state:r,lastUpdatedAt:o}}).then(e=>e.result.ok?Promise.resolve(t):(console.log("response from db not ok: ",e),Promise.reject(e))).catch(e=>(console.log("error updateMany:",e),Promise.reject(e)))))}updateTrendWithStoryCount(e,t,r,o,i,n){let l=new Date;return this.getDb().flatMap(a=>s.a.Observable.fromPromise(a.collection("trends").updateOne({countryCode:e,term:t},{$set:{storyCount:r,state:o,horizon:i,features:n,lastUpdatedAt:l}}).then(e=>e.result.ok?(console.log("response from db ok"),Promise.resolve(!0)):(console.log("response from db NOT ok: ",e),Promise.resolve(!1)))))}}},"./build/webtask/notifier.js":function(e,t,r){"use strict";r.r(t),r.d(t,"Notifier",function(){return a});var o=r("rx"),s=r.n(o),i=r("requestretry"),n=r.n(i),l=r("./build/src/models/article.js");(e=e||{}).webtask=webtaskApi;class a{constructor(e){this.segments=["active_30_days"],this.sendTestNotification=!1,this.secrets=e}sendNotification(e,t){if(0==t.length)return s.a.Observable.of({});let r=e.name,o=e.id;e.redirectSource&&(r=e.redirectSource,o=e.redirectSource);let i=this.getTopStories(t);return 0==i.length&&t.length>0&&(!e.id.startsWith("google-trending-search-")&&o.startsWith("default_")||(i=t)),i=i.slice(0,1),this.sendNotificationInternal(o,r,i)}getTopStories(e){return e.filter(e=>e.isTitleImportant())}getFilters(e){let t=[];if(e.startsWith("default_")){let r={field:"country",relation:"=",value:e.substring(8).toUpperCase()};t.push(r)}else{let r={field:"tag",key:`not:${e}`,relation:"exists"};t.push(r)}t.push({field:"app_version",relation:">",value:"10"});let r={field:"tag",key:`quiet_hours:${(new Date).getUTCHours()}`,relation:"not_exists"};return t.push(r),t}getHeading(e,t){let r=`Story from ${e}`;return e.startsWith("default_")?r="Top stories":t.length>1&&(r=`${t.length} stories from ${e}`),r}sendNotificationInternal(e,t,r){if(0==r.length)return s.a.Observable.of({});let o=this.getHeading(t,r),i=r[0],l=(encodeURIComponent(i.url),{field:"tag",key:`not:${e}`,relation:"exists"}),a={field:"tag",key:`quiet_hours:${(new Date).getUTCHours()}`,relation:"not_exists"};const u={app_id:this.secrets.onesignal_id,contents:{en:i.title},headings:{en:o},data:{type:"stories",stories:r.map(e=>this.minStory(e))},large_icon:this.cdnImage(i.urlToImage),android_accent_color:"D9C70029",ttl:7200,included_segments:this.segments,filters:[l,a,{field:"app_version",relation:">",value:"10"}],collapse_id:"feed_"+e},c={method:"POST",uri:"https://onesignal.com/api/v1/notifications",body:u,json:!0,headers:{"Content-Type":"application/json",Authorization:`Basic ${this.secrets.onesignal_key}`},fullResponse:!1,maxAttempts:1};if(this.sendTestNotification){let e=JSON.parse(JSON.stringify(c)),t=e.body;delete t.url,delete t.included_segments,delete t.filters,t.headings={en:"Test notifications only for you"},t.include_player_ids=["dba7a488-0bb0-4296-a2bf-85039cbfc8b1"],n()(e)}return s.a.Observable.fromPromise(n()(c).then(e=>(console.log("onesignal response:",e),null!=e.recipients?(e.msg=o,Promise.resolve(e)):Promise.reject(e))).catch(t=>{let r={method:"POST",uri:"https://hooks.slack.com/services/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",body:{text:`error sending ${u.data.stories.length} stories from ${e}: ${JSON.stringify(t).substr(0,400)}`},json:!0,fullResponse:!1,maxAttempts:1};n()(r)}))}cdnImage(e){return l.Article.isGIF(e)||e.match(/img.youtube.com/)||e.match(/cdn/)?e:`https://res.cloudinary.com/nooz/image/fetch/w_96/${encodeURIComponent(e)}`}minStory(e){let t=l.Article.fromDumbJson(e);return delete t.tags,delete t.highlights,delete t.entities,delete t.htmlBody,delete t.summary,t}}},"./build/webtask/scraper-config.js":function(e,t,r){"use strict";r.r(t),r.d(t,"ScraperConfig",function(){return i});var o=r("requestretry"),s=r.n(o);(e=e||{}).webtask=webtaskApi;class i{static matchSelector(e,t){if(e[t])return e[t];let r=Object.keys(e),o=r.findIndex(e=>t.endsWith(e));return o>-1?e[r[o]]:void 0}static protectedByCloudflare(e){return i.matchSelector({"coindesk.com":!0},e)}static cruftSelectors(e){return i.matchSelector(i.CRUFT_HTML_SELECTORS,e)}static details(e){return i.matchSelector(i.DETAILS_CONFIG,e)}static list(e){let t,r={},o="",s="";switch(e){case"nis":r.uri="https://www.inshorts.com/en/read",o=".source";break;case"gnn":r.uri="https://www.goodnewsnetwork.org",o=".entry-title a";break;case"nis-offbeat":r.uri="https://www.inshorts.com/en/read/hatke",o=".source";break;case"thewire":s="https://thewire.in",r.uri="https://thewire.in",o=".card > * > a";break;case"coindesk":r.uri="https://www.coindesk.com/",o=".article",s="https://www.coindesk.com",t={url:"a",urlToImage:"img",publishedAt:".timeauthor time",title:"h3",description:"p:nth-child(3)",author:".timeauthor cite"};break;case"the-better-india":r.uri="https://www.thebetterindia.com/",o="article figure a";break;case"altnews":r.uri="https://www.altnews.in",o=".item-details a";break;case"ndtv-movie-reviews":r.uri="http://movies.ndtv.com/movie-reviews",o=".ndmv-celeb-list a";break;case"vccircle":r.uri="https://www.vccircle.com",o=".article-details .title a";break;case"the-quint":r.uri="https://www.thequint.com/hot-news",o="a.card-elements__link",s="https://www.thequint.com";break;case"scroll":r.uri="https://scroll.in",o=".row-story a";break;case"qrius":r.uri="https://qrius.com/category/businesseconomics",o=".bnrdetail > a,.col-md-4 > a";break;case"indiatv-entertainment":r.uri="http://www.indiatvnews.com/entertainment",o=".list a.thumb";break;case"futurism":r.uri="https://www.futurism.com",o=".post-details h3 a";break;default:throw new Error("Invalid parser source "+e)}return{reqOptions:r,selector:o,subSelectors:t,prefixUrl:s}}static descCruftRegex(e){if(!e.domain){let t={method:"POST",uri:"https://hooks.slack.com/services/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",body:{text:"[scraper-config] null domain for story:"+`\nurl: ${e.url}\nsource: ${e.source}`},json:!0,fullResponse:!1,maxAttempts:1};s()(t)}return i.DESC_CRUFT_REGEX[e.source]||i.DESC_CRUFT_REGEX[e.domain]}static titleCruftRegex(e){return i.TITLE_CRUFT_REGEX[e.source]||i.TITLE_CRUFT_REGEX[e.domain]}}i.CRUFT_HTML_SELECTORS={default:".sharebar_expanded, .inline-sharebar, .sharethis-inline-share-buttons, .sharedaddy, .twitter-tweet, .instagram-media","abc.net.au":".topics, .published","bbc.co.uk":".story-image-copyright, .off-screen, .media-with-caption","metro.co.uk":".mor-link, .vjs-video-container, .vjs-no-js","mirror.co.uk":".read-more-links, .mod-video","mtv.co.uk":".promo-image","indiatimes.com":".top_articlelist, .coffeecmpgn, .loadingblock, .title_section, .relatedarticle, .img_cptn","thehindu.com":".article-topics-container, .outbrain-main-cont","huffingtonpost.com":".bn-share, .entry_footer, .related-articles, .advertisement, .before_related_media, .extra-content","newscientist.com":".author-byline, .image-details .credit","us.cnn.com":".el__storyhighlights","thequint.com":".story-article__hero, .story-article__content__element--blockquote"},i.DETAILS_CONFIG={"coindesk.com":{subSelectors:{htmlBody:".article-content-container",author:".article-featured .timeauthor a"}},"qrius.com":{subSelectors:{htmlBody:".single-content"}},"scroll.in":{subSelectors:{htmlBody:".article-body"}},"thequint.com":{subSelectors:{htmlBody:".story-article__cards"}},"thewire.in":{selector:"section:first-child",subSelectors:{title:".title",description:".shortDesc",author:".author",urlToImage:".featured-image img",htmlBody:".postComplete__description"}},"amarujala.com":{subSelectors:{htmlBody:".article-desc"}}},i.DESC_CRUFT_REGEX={"ccn.com":{regex:/Join our[^]*?per month./},"thebetterindia.com":{regex:/Support our endeavor[^]*?Learn more./},"economictimes.indiatimes.com":{regex:/DID YOU KNOW[^]*?Drag according to your convenience/}},i.TITLE_CRUFT_REGEX={tehelka:{regex:/\| Tehelka - Investigations,.*?Podcasts/},"amazingnature-twitter":{before:"#Url"},"firstpost.com":{regex:/LIVE News, Latest.*?coverage/}}},"./build/webtask/stories-provider-scraper.js":function(e,t,r){"use strict";r.r(t),r.d(t,"StoriesProviderScraper",function(){return a});var o=r("rx"),s=r.n(o),i=r("./build/webtask/scraper-config.js"),n=r("./build/webtask/story-parse-utils.js"),l=r("./build/webtask/base-scraper.js");(e=e||{}).webtask=webtaskApi;class a extends l.BaseScraper{constructor(){super()}getStories(e){let t=i.ScraperConfig.list(e);return this.getStoriesByConfig(e,t)}getStoriesByConfig(e,t,r=20){let o=t.prefixUrl||"";return s.a.Observable.fromPromise(this.getHtmlBody(t.reqOptions).then(function(s){console.log("received success from "+t.reqOptions.uri);let i=document.createElement("DIV");i.innerHTML=s;let l=i.querySelectorAll(t.selector),u=Math.min(l.length,r),c=[],d=[];for(var m=0;m<u;m++){let r,s=l[m];if(t.subSelectors){let i=t.subSelectors;r=n.StoryParseUtils.fromJson({source:e,url:a.toUrl(a.parseUrl(s,i.url),o),urlToImage:a.toUrl(a.parseUrl(s,i.urlToImage),o),title:a.parseText(s,i.title),description:a.parseText(s,i.description),author:a.parseText(s,i.author),publishedAt:a.parseDatetime(s,i.publishedAt)})}else{let t=a.toUrl(s.getAttribute("href"),o);r=n.StoryParseUtils.fromJson({url:t,source:e})}d.indexOf(r.url)<0&&!n.StoryParseUtils.isLowFidelityDomain(r.domain)&&(c.push(r),d.push(r.url))}return console.log("parsed "+c.length+" stories from "+e),Promise.resolve(c)}))}}},"./build/webtask/stories-provider.js":function(e,t,r){"use strict";r.r(t),r.d(t,"StoriesProvider",function(){return g});var o=r("rx"),s=r.n(o),i=r("requestretry"),n=r.n(i),l=r("./build/webtask/story-parse-utils.js"),a=r("./build/webtask/stories-provider-scraper.js"),u=r("./build/webtask/story-details-provider.js"),c=r("./build/src/models/article.js"),d=r("./build/src/models/source.js"),m=r("./build/webtask/trends-provider.js");(e=e||{}).webtask=webtaskApi;class g{constructor(e,t){this.data=e,this.secrets=t,this.listScraper=new a.StoriesProviderScraper,this.detailsProvider=new u.StoryDetailsProvider(t)}getStoryDetails(e,t,r=5){return this.detailsProvider.getStoryDetails(e,t,r)}getFreshStories(e){let t=(new Date).getTime()-3456e5;return this.getStories(e).map(r=>{console.log(`getFreshStories: got ${r.length} stories`),e.aggregator!=d.Source.AGGREGATOR_YT&&e.aggregator!=d.Source.AGGREGATOR_TWITTER&&(r=r.filter(e=>!l.StoryParseUtils.isLowFidelityDomain(e.domain)),console.log(`getFreshStories: left with ${r.length} stories after removing low fidelity domains`));let o=r.filter(e=>!e.publishedAt||e.publishedAt.getTime()>t),s=r.length-o.length;return s>0&&console.log(`getFreshStories: rejected ${s} stale stories`),{freshStories:o,staleStoriesCount:s}})}getStories(e){let t=e.id;return console.log(`fetching ${t} stories from ${e.aggregator}`),d.Source.AGGREGATOR_REDDIT==e.aggregator?this.getStoriesFromReddit(e):d.Source.AGGREGATOR_TWITTER==e.aggregator?this.getStoriesFromTwitter(e):d.Source.AGGREGATOR_YT==e.aggregator?this.getStoriesFromYT(e):d.Source.AGGREGATOR_NEWSAPI==e.aggregator?this.getStoriesFromNewsApi(t):d.Source.AGGREGATOR_1R==e.aggregator?this.getStoriesFrom1R(t):d.Source.AGGREGATOR_NEWZCONE==e.aggregator?this.getStoriesFromNewzcone(t):d.Source.AGGREGATOR_MISCAPI==e.aggregator?this.getStoriesFromMiscApi(t):this.listScraper.getStories(t)}getStoriesFromReddit(e){let t=e.aggregatorSource;if(!t||0==t.length)return s.a.Observable.fromPromise(Promise.reject("no subreddits found for source: "+e));let r=t.split(" ");return s.a.Observable.forkJoin(r.map(e=>this.getHotArticlesBySubreddit(e))).map(e=>{let t=[];for(let r of e)t=t.concat(r);return t}).map(t=>(t.forEach(t=>t.source=e.id),t))}getHotArticlesBySubreddit(e){console.log("fetching stories subreddit:"+e);const t={uri:`https://www.reddit.com/r/${e}.json`,qs:{restrict_sr:"on",sort:"hot",t:"week"},headers:{"User-Agent":"android:com.example.theredditapp:v1.2.3"},json:!0,fullResponse:!1,maxAttempts:1};return s.a.Observable.fromPromise(n()(t).then(e=>Promise.resolve(l.StoryParseUtils.fromRedditList(e))))}getStoriesFromYT(e){let t=e.aggregatorSource;if(!t||0==t.length)return s.a.Observable.fromPromise(Promise.reject("no ytchannels found for source: "+e));const r={uri:"https://www.googleapis.com/youtube/v3/search",qs:{key:this.secrets.yt_key,channelId:t,order:"date",type:"video",videoEmbeddable:"true",maxResults:10,fields:"items(id/videoId,snippet/title,snippet/description)",part:"snippet"},json:!0,fullResponse:!1,maxAttempts:1};return s.a.Observable.fromPromise(n()(r).then(t=>{let r=l.StoryParseUtils.fromYTList(t);return r.forEach(t=>t.source=e.id),Promise.resolve(r)}))}getStoriesFromTwitter(e){let t=e.aggregatorSource;if(!t)return s.a.Observable.fromPromise(Promise.reject("no screenName found for source: "+e));var o=new(r("twit"))({consumer_key:this.secrets.twitter_consumer_key,consumer_secret:this.secrets.twitter_consumer_secret,app_only_auth:!0,timeout_ms:1e4});return s.a.Observable.fromPromise(o.get("statuses/user_timeline",{screen_name:t,count:10,trim_user:!0,exclude_replies:!0,include_rts:!1}).then(r=>{console.log("data",r.data);let o=l.StoryParseUtils.fromTwitterList(e.id,t,r.data);return o.forEach(t=>t.source=e.id),Promise.resolve(o)}))}getStoriesFromNewsApi(e){let t={apiKey:this.secrets.newsapi_key,pageSize:10};if(e.startsWith("newsapi_top_")){let r=e.slice(12);t.country=r}else t.sources=e;const r={uri:`https://newsapi.org/v2/${g.NEWSAPI_SEARCH_EVERYTHING_CHANNELS.indexOf(e)>-1?"everything":"top-headlines"}`,qs:t,json:!0,fullResponse:!1,maxAttempts:1};return s.a.Observable.fromPromise(n()(r).then(t=>{if(!t.articles)return Promise.reject(t.message);let r=t.articles.map(t=>l.StoryParseUtils.fromNewsApi(t,e));return Promise.resolve(r)}))}getStoriesFromMiscApi(e){if("betalist"==e){const t={uri:"https://api.betalist.com/v1/startups",qs:{per_page:10,access_token:this.secrets.betalist_key},json:!0,fullResponse:!1,maxAttempts:1};return s.a.Observable.fromPromise(n()(t).then(t=>{if(!t.startups)return Promise.reject(t.message);let r=t.startups.map(t=>l.StoryParseUtils.fromJson({description:t.pitch,publishedAt:t.featured_at,title:t.name,url:t.website_url,urlToImage:t.thumbnail_url,source:e}));return Promise.resolve(r)}))}if("newslaundry"==e){const t={uri:"https://www.newslaundry.com/api/posts",qs:{limit:10},json:!0,fullResponse:!1,maxAttempts:1};return s.a.Observable.fromPromise(n()(t).then(t=>{if(!t.data)return Promise.resolve([]);let r=t.data.map(t=>{let r=null;(t.img_path||t.img_path.length>0)&&(r=t.img_path[0]);let o=`https://www.newslaundry.com/${this.formatDateYYYYMMDD(new Date(t.post_date))}/${t.post_name}`;return l.StoryParseUtils.fromJson({description:t.post_excerpt,publishedAt:t.post_date,title:t.post_title,author:t.author,url:o,urlToImage:r,source:e})});return Promise.resolve(r)}))}if(e.startsWith("google-trending-search-")){let t=e.slice(23);return new m.TrendsProvider(this.secrets,t).topGoogleTrendsRaw().map(t=>{let r=[];return t&&t.forEach(t=>{t.newsArticlesList&&(r=r.concat(t.newsArticlesList.map(t=>l.StoryParseUtils.fromGoogleTrendNewsArticle(t,e))))}),r})}return null}getStoriesFrom1R(e){let t=this.getSourceData(e);const r={uri:`http://reader.one/api/news/${e}`,qs:{limit:"10","User-Agent":"Mozilla/5.0 (Linux; U; Android 4.0; en-us; GT-I9300 Build/IMM76D) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30",Host:"reader.one",Referer:"http://reader.one/"},headers:t&&t.etag?{"If-None-Match":t.etag}:{},maxAttempts:1};return s.a.Observable.fromPromise(n()(r).then(r=>{if("304"==r.statusCode)return console.log(`no new ${e} stories from 1r per etag`),Promise.resolve([]);if("200"!=r.statusCode)return console.log(`got failure from 1r api for ${e}: ${r.statusCode}`,r.body),Promise.reject(r.body);let o=r.headers.etag;console.log(`1r ${e} etag: ${o}`),o&&(t.etag=o);let s=JSON.parse(r.body),i=[];return s&&s.length>0&&(i=s.map(t=>l.StoryParseUtils.from1R(t,e))),Promise.resolve(i)}))}getStoriesFromNewzcone(e){let t={"economic-times":{path:"business/",domain:"economictimes.indiatimes.com"},zdnet:{path:"technology/networking-telecom/",domain:"zdnet.com"},"navbharat-times":{path:"regional/hindi/",domain:"navbharattimes.indiatimes.com"},"amar-ujala":{path:"regional/hindi/",domain:"amarujala.com"},"the-newsminute":{path:"top-stories/more-stories/",domain:"thenewsminute.com"},tehelka:{path:"top-stories/more-stories/",domain:"tehelka.com"},"oneindia-telugu":{path:"regional/telugu/",domain:"telugu.oneindia.com"},dinamalar:{path:"regional/tamil/",domain:"dinamalar.com",domainregex:"feedproxy.google.com.*dinamalar"},"google-news-in-sports":{path:"sports/",domain:"news.google.com",urlregex:"&url=(.*)"}}[e],r={reqOptions:{uri:"http://www.newzcone.com/"+t.path},selector:"a.itemtitle",prefixUrl:""};return this.listScraper.getStoriesByConfig(e,r,500).map(e=>e.filter(e=>e.domain==t.domain||!(!t.domainregex||!e.url.match(t.domainregex)))).map(e=>(e.forEach(e=>{if(t.urlregex){let r=e.url.match(t.urlregex);if(r){let t=r[1];c.Article.isUrl(t)&&(e.url=t,e.domain=c.Article.extractHostname(t))}}}),e))}formatDateYYYYMMDD(e){let t=""+(e.getMonth()+1),r=""+e.getDate(),o=e.getFullYear();return t.length<2&&(t="0"+t),r.length<2&&(r="0"+r),[o,t,r].join("/")}getSourceData(e){let t=this.data.source2data;return console.log("source2data:",t),t[e]||(t[e]={source:e}),t[e]}}g.NEWSAPI_SEARCH_EVERYTHING_CHANNELS=[]},"./build/webtask/stories-summarizer.js":function(e,t,r){"use strict";r.r(t),r.d(t,"StoriesSummarizer",function(){return a});var o=r("rx"),s=r.n(o),i=r("requestretry"),n=r.n(i),l=r("./build/webtask/story-parse-utils.js");(e=e||{}).webtask=webtaskApi;class a{getSummaryFromHtmlBody(e,t){if(!t)return null;if("timesofindia.indiatimes.com"==e){var r=document.createElement("DIV");r.innerHTML=t;let e=r.querySelector("artsummary ul");if(e){let t=e.querySelectorAll("li"),r=[];for(var o=0;o<t.length;o++){let e=t[o].textContent;e&&r.push(e)}if(r.length>=2)return r}}return null}getStorySummary(e,t=4){let r=l.StoryParseUtils.textBody(e);if(!r)return console.log("no textBody found for article:"+e.url),s.a.Observable.of(e);if(e.originalWordCount&&e.originalWordCount<150)return console.log("skipping summary generation for short article:"+e.url),e.summary=[r],s.a.Observable.of(e);let o=this.getSummaryFromHtmlBody(e.domain,e.htmlBody);if(o&&(this.updateStoryWithSummary(e,o,!0),e.summary&&e.summary.length>1))return console.log("found summary from html body. skipping api call for "+e.url),s.a.Observable.of(e);const i={method:"POST",uri:"https://baskin.pythonanywhere.com/summarize",headers:{"Content-Type":"application/json"},body:{title:e.title,html:e.htmlBody,sentence_count:t},json:!0,fullResponse:!1,maxAttempts:2,retryDelay:500};return s.a.Observable.fromPromise(n()(i).then(t=>{console.log("got success from summarizer for "+e.url);let r=t.sentences.map(e=>l.StoryParseUtils.textFromHtml(e));return this.updateStoryWithSummary(e,r),Promise.resolve(e)}))}updateStoryWithSummary(e,t,o){let s=t.join(" "),i=s.split(/\s+/).length;if(i>1200)console.log("ignoring long summary for "+e.url,t);else if(i<25&&!o)console.log("ignoring short summary for "+e.url,t);else if(s.length<e.description.length&&!o)console.log("ignoring summary shorter than description for "+e.url,t);else{const o=r("fuzzball"),l=r("compromise");let a=l(e.title+" "+e.description).nouns().normalize().unique().out("text"),u=l(s).nouns().normalize().unique().out("text"),c=o.token_set_ratio(a,u);if(console.log("fuzzball ratio (desc|summary): "+c),c<20){console.log("ignoring potentially unrelated summary for "+e.url);let t={method:"POST",uri:"https://hooks.slack.com/services/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",body:{text:`[stories-summarizer] potentially unrelated summary (${c}/100) for url ${e.url}. `+`\ndescription: ${e.description}\nsummary: ${s}`},json:!0,fullResponse:!1,maxAttempts:1};n()(t)}else e.summary=t,e.summaryWordCount=i}}}},"./build/webtask/story-details-provider.js":function(e,t,r){"use strict";r.r(t),r.d(t,"StoryDetailsProvider",function(){return g});var o=r("rx"),s=r.n(o),i=r("requestretry"),n=r.n(i),l=r("./build/webtask/scraper-config.js"),a=r("./build/webtask/story-parse-utils.js"),u=r("./build/webtask/base-scraper.js"),c=r("./build/webtask/stories-summarizer.js"),d=r("./build/src/models/article.js"),m=r("./build/src/models/source.js");(e=e||{}).webtask=webtaskApi;class g extends u.BaseScraper{constructor(e){super(),this.secrets=e,this.summarizer=new c.StoriesSummarizer}getStoryDetails(e,t,r=5){return this.getStoryDetailsInner(e,t,r).flatMap(t=>m.Source.DETAILS_PROVIDER_SCRAPER!=e.detailsProvider&&m.Source.DETAILS_PROVIDER_SCRAPER_UNFLUFF!=e.detailsProvider&&t.title&&t.title.match(/(^|\s)watch(\s|$)|(^|\s)video(\s|$)|(^|\s)trailer(\s|$)|(^|\s)look(\s|$)|(^|\s)preview(\s|$)|(^|\s)peek(\s|$)|(^|\s)camera(\s|$)/i)&&!t.urlToVideo?s.a.Observable.fromPromise(this.getHtmlBody({uri:t.url,gzip:!0,rejectUnauthorized:!1}).then(e=>{let r=a.StoryParseUtils.getVideo(e);return d.Article.isUrl(r)&&(console.log("parsed video using raw html since title contained watch|video"),t.urlToVideo=r),Promise.resolve(t)}).catch(e=>(console.log("Ignoring error from scraper while parsing for video:",e),Promise.resolve(t)))):s.a.Observable.of(t))}getStoryDetailsInner(e,t,r=5){let o=d.Article.fromDumbJson(t);return m.Source.DETAILS_PROVIDER_NONE!=e.detailsProvider&&this.doFetchDetails(o)?(console.log("getting story details for url:"+t.url),this.getArticleFromUrl(o.url,e).flatMap(t=>this.doFetchSummary(e)?this.summarizer.getStorySummary(t):s.a.Observable.of(t))):(console.log("not returning story details for url:"+t.url),s.a.Observable.of(o))}doFetchSummary(e){return"en"==e.language}doFetchDetails(e){return!d.Article.isImageUrl(e.url)&&(null==e.url.match(/\.(pdf|doc|docx)$/i)&&(!e.domain.match(/youtube|youtu.be|github|slashdot|twitter|zeenews/)&&!e.domain.match(/buzzfeed/)))}getArticleFromUrl(e,t){return m.Source.DETAILS_PROVIDER_SCRAPER===t.detailsProvider||m.Source.DETAILS_PROVIDER_SCRAPER_UNFLUFF===t.detailsProvider?this.getStoryDetailsFromScraper(e,t.id,m.Source.DETAILS_PROVIDER_SCRAPER_UNFLUFF===t.detailsProvider).catch(r=>{console.log("getStoryDetailsFromScraper errored with "+r+". Retrying with mercury parser");let o=this.getStoryFromMercuryParser(e,t.id);return global.rollbar&&global.rollbar.info("scraper error mercury success"),o}):this.getStoryFromMercuryParser(e,t.id).catch(r=>{console.log("getStoryFromMercuryParser errored with "+r+". Retrying with scraper");let o=this.getStoryDetailsFromScraper(e,t.id,!0);return global.rollbar&&global.rollbar.info("mercury error scraper success"),o})}getStoryFromMercuryParser(e,t){const r={uri:"https://mercury.postlight.com/parser",qs:{url:e},headers:{"Content-Type":"application/json","x-api-key":this.secrets.mercury_key},json:!0,fullResponse:!1,maxAttempts:2,retryDelay:500};return s.a.Observable.fromPromise(n()(r).then(r=>r.errorMessage?(console.log("got failure from mercury"),Promise.reject(r.errorMessage)):(console.log("got success from mercury for "+e),r.url=e,r.source=t,Promise.resolve(a.StoryParseUtils.fromMercury(r)))).catch(e=>{throw new Error("mercury parsing error:"+JSON.stringify(e))}))}static getDataByOGMeta(e,t){let r,o,s,i,n,l=e.getElementsByTagName("meta"),u=[];for(let e=0;e<l.length;e++){let t=l[e].getAttribute("content"),a=l[e].getAttribute("property")||l[e].getAttribute("itemprop");if("og:url"==a&&(r=t),"og:image"!=a&&"og:image:secure_url"!=a&&"image"!=a||(o=t),"article:published_time"!=a&&"og:article:published_time"!=a&&"datePublished"!=a||(n=new Date(t)),"og:title"!=a&&"headline"!=a||(s=t),"og:description"!=a&&"description"!=a||(i=t),("news_keywords"==a||"keywords"==a||"article:tag"==a)&&t){let e=t.split(",");(e=e.filter(e=>!e.match(/news|latest|update|today|week|feature/i))).length>0&&(u=u.concat(e))}}return 0==u.length?u=null:console.log("Constructed tags out of OGMeta:",u),r&&!a.StoryParseUtils.compareUrls(t,r)?(console.log(`OGMeta url ${r} is not same as root url ${t}`),{}):{url:r,urlToImage:o,title:s,description:i,publishedAt:n,tags:u}}static unfluffStoryDetailsFromHtml(e,t,o){let s=r("unfluff")(o),i=null,n=null;if(s.videos&&s.videos.length>0)for(let e=0;e<s.videos.length;e++){let t=s.videos[e].src;if(t&&(i=a.StoryParseUtils.normalizeVideoUrl(t)))break}s.author&&s.author.length>0&&(n=a.StoryParseUtils.normalizeAuthor(s.author[0]));let l=g.extractPrefixUrl(e),u=g.toUrl(s.canonicalLink||e,l);d.Article.isUrl(u)||u===e||u.substr(u.lastIndexOf("/")+1)===e.substr(e.lastIndexOf("/")+1)&&(u=e);let c={source:t,url:u,urlToImage:g.toUrl(s.image,l),title:s.title||s.softTitle,description:s.description,author:n,publishedAt:s.date,htmlBody:s.text,tags:s.tags,urlToVideo:i,language:s.lang};if(!c.url||!c.title)throw new Error("unfluff returned story with missing fields:"+JSON.stringify(c));return a.StoryParseUtils.fromJson(c)}static getStoryDetailsFromHtml(e,t,r){let o=d.Article.extractHostname(e),s=document.createElement("DIV");s.innerHTML=r;let i=g.getDataByOGMeta(s,e),n=l.ScraperConfig.details(o);if(null==n){if(console.log("Scraper config is null for fetching details of domain "+o),i&&i.url&&i.title)return console.log("Returning story built via meta tags"),i.source=t,a.StoryParseUtils.fromJson(i);throw new Error("No scraper config found for domain and no OGMeta tags")}let u=n.selector?s.querySelector(n.selector):s,c=n.subSelectors,m=n.prefixUrl||"",p=g.parseUrl(u,c.url)||i.url||e;p&&(p=g.toUrl(p,m));let f=g.parseUrl(u,c.urlToImage)||i.urlToImage;return f&&(f=g.toUrl(f,m)),a.StoryParseUtils.fromJson({source:t,url:p,urlToImage:f,title:g.parseText(u,c.title)||i.title,description:g.parseText(u,c.description)||i.description,author:g.parseText(u,c.author),publishedAt:g.parseDatetime(u,c.publishedAt)||i.publishedAt,htmlBody:g.parseHtml(u,c.htmlBody),tags:i.tags})}getStoryDetailsFromScraper(e,t,r){return console.log("Getting story details from parser for "+e),s.a.Observable.fromPromise(this.getHtmlBody({uri:e,gzip:!0,rejectUnauthorized:!1}).then(function(o){console.log("received success from "+e);let s=r?g.unfluffStoryDetailsFromHtml(e,t,o):g.getStoryDetailsFromHtml(e,t,o);return Promise.resolve(s)}))}}},"./build/webtask/story-parse-utils.js":function(e,t,r){"use strict";r.r(t),r.d(t,"StoryParseUtils",function(){return u});r("./node_modules/core-js/modules/es6.array.sort.js");var o=r("compromise"),s=r.n(o),i=r("./build/src/models/article.js"),n=r("./build/webtask/scraper-config.js"),l=r("requestretry"),a=r.n(l);(e=e||{}).webtask=webtaskApi;class u{static getCleanText(e,t){let r=u.getCleanDisplayHtml(e,t);return u.textFromHtml(r)}static getVideo(e){if(!e)return null;var t=document.createElement("DIV");t.innerHTML=e;let r=t.querySelectorAll("iframe, embed, video");for(let e=0;e<r.length;e++){let t=r.item(e).src||r.item(e).baseURI;if(t&&(t=u.normalizeVideoUrl(t)))return t}return null}static normalizeVideoUrl(e){console.log("[story-parse-utils] normalizing video url: "+e);const t=r("normalize-url");return e.includes("youtube.com/embed/")||e.includes("youtube-nocookie.com/embed")?t(e,{removeQueryParameters:[/.*/]}):e.endsWith(".mp4")?t(e):e.startsWith("https://www.facebook.com/plugins/video.php?href=")?(e=e.replace("https://www.facebook.com/plugins/video.php?href=",""),t(e=decodeURIComponent(e.split("&")[0]).replace(/\/+$/,""))):e.includes("dailymotion.com/embed")?t(e,{removeQueryParameters:[/.*/]}):e.includes("player.vimeo.com/video")?t(e,{removeQueryParameters:[/.*/]}):null}static getCleanDisplayHtml(e,t){if(!t)return t;e=e.toLowerCase();let r=n.ScraperConfig.details(e);if(r&&r.subSelectors&&r.subSelectors.htmlBody){var o=document.createElement("DIV");o.innerHTML=t;let s=o.querySelector(r.subSelectors.htmlBody);if(s){console.log("[story-parse-utils] found body element for domain "+e);let t=u.getCleanDisplayHtmlInner(e,s.outerHTML);if(t)return t;console.log("[story-parse-utils] warning body selector gave null html for domain "+e)}else console.log("[story-parse-utils] warning body selector gave null element for domain "+e)}return u.getCleanDisplayHtmlInner(e,t)}static getCleanDisplayHtmlInner(e,t){if(!t)return t;t=(t=(t=u.stripImgScriptStyle(t)).replace(/<figcaption([\S\s]*?)>([\S\s]*?)<\/figcaption>/gi,"")).replace(/<figure([\S\s]*?)>([\S\s]*?)<\/figure>/gi,"");let r=n.ScraperConfig.cruftSelectors("default");t=u.trimDomBySelector(t,r);let o=n.ScraperConfig.cruftSelectors(e);return t=u.trimDomBySelector(t,o),t=u.trimDomBySelector(t,"figure, figcaption")}static trimDomBySelector(e,t){if(t&&t.length>0){var r=document.createElement("DIV");r.innerHTML=e,e=r.innerHTML;let o=r.querySelectorAll(t);for(let t=0;t<o.length;t++){let r=o.item(t).outerHTML;console.log("[story-parse-utils] removing from dom:",r),e=e.replace(r,"")}}return e}static stripImgScriptStyle(e){return e=(e=(e=e.replace(/<img[^>"']*((("[^"]*")|('[^']*'))[^"'>]*)*>/g,"")).replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")).replace(/<style([\S\s]*?)>([\S\s]*?)<\/style>/gi,"")}static normalizeTitle(e){let t=e.title;if(t&&(t=t.trim()),!t)return console.log("[story-parse-utils] no title found in normalizeTitle()"),t;if(e.source){let r=e.source.trim();t=u.stripLeadingOrTrailing(t,r.toLowerCase().split("-").join(" ")),t=u.stripLeadingOrTrailing(t,r.toLowerCase().split("-").filter(e=>"the"!=e).join(" ")),t=u.stripLeadingOrTrailing(t,r.toLowerCase().split("-").join(""))}t=t.replace(/(^[,-\s]+)|([,-\s]+$)/g,"");let r=n.ScraperConfig.titleCruftRegex(e);return r&&(t=u.removeCruft(r,t)),t?t.trim():t}static normalizeAuthor(e){return s()(e).people().out("text")}static stripLeadingOrTrailing(e,t){let r=e;return r.toLowerCase().startsWith(t)&&(r=r.slice(t.length)),r.toLowerCase().endsWith(t)&&(r=r.slice(0,r.length-t.length)),r?r.trim():r}static normalizeDescription(e,t){let r=e.description||"";if(((r=r.trim())==e.title||r.length<u.MIN_DESC_LENGTH)&&t){let o=t,i=s()(t).sentences();if(i.length>4){let e=i.slice(0,4).out();e.length>u.MIN_DESC_LENGTH&&(o=e)}if(o.length>u.MAX_DESC_LENGTH){o=o.substr(0,u.MAX_DESC_LENGTH);let e=s()(o).terms();o=e.slice(0,e.length-1).out()+"..."}(r==e.title||o.length>r.length)&&(console.log(`[story-parse-utils] overriding desc '${r}' with snippet from textBody '${o}'`),r=o)}let o=u.textFromHtml(r),i=n.ScraperConfig.descCruftRegex(e);if(i){console.log("[story-parse-utils] will remove cruft:",i);let t=u.removeCruft(i,o);if(console.log(`[story-parse-utils] cleaned up cruft "${o}" -> "${t}"`),o&&(!t||t.length<5)){let r={method:"POST",uri:"https://hooks.slack.com/services/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",body:{text:"[story-parse-utils] remove desc cruft caused missing desc:"+`\nurl: ${e.url}\nsource: ${e.source}`+`\ndescription: ${o}\ncleaned: ${t}`},json:!0,fullResponse:!1,maxAttempts:1};a()(r)}o=t}return o?o.trim():o}static removeCruft(e,t){if(e.regex)return t.replace(e.regex,"");let r=s()(t);return e.after&&r.match(e.after)?r.after(e.after).out():e.before&&r.match(e.before)?r.before(e.before).out():t}static doFlag(e){let t=e.title;if(!t)return!1;let r=t.split(/\s/);return u.POTTY_WORDS.some(e=>r.indexOf(e)>-1)}static fromJson(e){let t=i.Article.fromDumbJson(e);if(!i.Article.isUrl(t.url))throw new Error("Invalid url for story: "+t.url);if(t.publishedAt&&t.publishedAt.getTime()-(new Date).getTime()>0&&(console.log("[story-parse-utils] resetting publish time of article to now from ",t.publishedAt),t.publishedAt=new Date),t.urlToImage&&u.isPlaceholderImage(t.urlToImage)&&(console.log("[story-parse-utils] remove image from story since it is a placeholder image"),t.urlToImage=null),!t.urlToVideo){let e=u.getVideo(t.htmlBody);i.Article.isUrl(e)&&(t.urlToVideo=e)}t.htmlBody=u.getCleanDisplayHtml(t.domain,t.htmlBody||""),t.htmlBody||console.log("[story-parse-utils] warning: no html body found"),t.title=u.normalizeTitle(t);let r=u.textBody(t);if(t.description=u.normalizeDescription(t,r),!t.originalWordCount&&r&&(t.originalWordCount=r.split(/\s+/).length),t.summary=t.summary||[],t.summary.length>0){let e=n.ScraperConfig.descCruftRegex(t);e&&(t.summary=t.summary.map(t=>u.removeCruft(e,t)))}!t.summaryWordCount&&t.summary.length>0&&(t.summaryWordCount=t.summary.join(" ").split(/\s+/).length),t.tags&&t.tags.length>0&&(t.tags=t.tags.filter(e=>e).map(e=>e.trim()));let o=u.doFlag(t);return o&&(t.flag=o),t}static isPlaceholderImage(e){return u.PLACEHOLDER_IMAGES.some(t=>e.includes(t))}static compareUrls(e,t){if(e===t)return!0;const o=r("normalize-url");let s=o(e),i=o(t);return s===i||(s.endsWith(i)||i.endsWith(s))}static textBody(e){return e.htmlBody?u.getCleanText(e.domain,e.htmlBody).trim()||"":null}static textFromHtml(e){e=u.stripImgScriptStyle(e);var t=document.createElement("DIV");return t.innerHTML=e,t.textContent||t.innerText||""}static fromNewsApi(e,t){return e.source=t,u.fromJson(e)}static from1R(e,t){return u.fromJson({url:e.url,title:e.title,source:t})}static fromReddit(e){let t={};if(t.title=e.title,t.description=e.title,e.title.length>256&&(t.title=t.title.substr(0,256)+"..."),t.url=e.url,e.preview&&e.preview.images&&e.preview.images.length>0){let r=e.preview.images[0];r&&r.source&&(t.urlToImage=r.source.url)}return t.urlToImage||(t.urlToImage=e.thumbnail),t.urlToImage&&(t.urlToImage=t.urlToImage.replace(/&amp;/g,"&")),e.created_utc&&(t.publishedAt=new Date(0),t.publishedAt.setUTCSeconds(e.created_utc)),u.fromJson(t)}static fromYTList(e){if(null==e||null==e.items)return console.log("[story-parse-utils] yt result is empty"),[];let t=[];for(let r of e.items){let e={},o=r.id.videoId;e.title=r.snippet.title,e.description=r.snippet.description,e.url=`https://youtube.com/embed/${o}`,e.urlToVideo=e.url;let s="mqdefault";e.urlToImage=`https://img.youtube.com/vi/${o}/${s}.jpg`,t.push(i.Article.fromDumbJson(e))}return t}static fromTwitterList(e,t,r){if(null==r)return console.log("[story-parse-utils] twitter result is empty"),[];let o=[];for(let s of r){let r={};r.title=s.text,r.description=s.text,r.source=e,r.publishedAt=new Date(s.created_at),r.url=`https://twitter.com/${t}/status/${s.id_str}`;let i=[];s.entities&&s.entities.media&&(i=s.entities.media),s.extended_entities&&s.extended_entities.media&&(i=i.concat(s.extended_entities.media));let n=i.filter(e=>"photo"==e.type),l=i.filter(e=>"video"==e.type&&e.video_info);n&&n.length>0&&(r.urlToImage=n[0].media_url_https||n[0].media_url),l&&l.length>0&&l[0].video_info.variants&&(r.urlToVideo=u.bestVideoVariantTwitterUrl(l[0].video_info.variants)),o.push(u.fromJson(r))}return o}static bestVideoVariantTwitterUrl(e){let t=e.filter(e=>"video/mp4"==e.content_type);return t.length>0?t.sort((e,t)=>e.bitrate>t.bitrate?1:-1)[0].url:null}static fromRedditList(e){if(null==e||null==e.data||null==e.data.children||0==e.data.children.length)return console.log("[story-parse-utils] reddit result is empty"),[];let t=[];for(let r of e.data.children){let e=r.data;if(e.gilded)continue;if(e.quarantine)continue;if(e.over_18)continue;if(e.is_self)continue;if(e.domain&&this.isLowFidelityDomain(e.domain))continue;let o=u.fromReddit(e);o.title&&o.url&&t.push(o)}return console.log(`[story-parse-utils] filtered ${e.data.children.length-t.length}/${e.data.children.length} stories`),t}static isLowFidelityDomain(e){return e.match(/serving-sys|pinkvilla|ft.com|.wordpress|tumblr|youtube|youtu.be|facebook|twitter|instagram|fakingnews|image.ibb.co|imgur|reddit|i.redd.it|gyfcat|streamable/)}static fromMercury(e){let t={};return 1!=e.total_pages&&console.log("[story-parse-utils] TODO handle multiple pages. data: ",e),t.htmlBody=e.content,t.description=e.dek||e.excerpt,t.publishedAt=e.date_published,t.title=e.title,t.url=e.url,t.urlToImage=e.lead_image_url,t.source=e.source,u.fromJson(t)}static fromGoogleTrendNewsArticle(e,t){let r={};return r.description=e.snippet,r.title=e.title,r.url=e.link,r.source=t,u.fromJson(r)}}u.MIN_DESC_LENGTH=128,u.MAX_DESC_LENGTH=640,u.POTTY_WORDS=["fuck","erotic","voyeur","incest","bdsm","boob","tit","masturbation"],u.BODY_HTML_SELECTOR={"scroll.in":".article-body"},u.PLACEHOLDER_IMAGES=["bsmedia.business-standard.com/include/_mod/site/html5/images/no-meta-preview.jpg","techcrunch.com/wp-content/uploads/2015/02/cropped-cropped-favicon-gradient.png","outlookindia.com/public/uploads/outlook-banner-img.gif","thehindu.com/static/theme/default/base/img/og-image.jpg","static.toiimg.com/photo/msid-47529300/47529300.jpg","tribuneindia.com/images/default_image.gif","dailypioneer.com/images-tdp/logo.jpg","s4.reutersmedia.net/resources_v2/images/rcom-default.png","http://b.fssta.com/uploads/2016/12/default_image","washingtonpost.com/pb/resources/img/twp-social-share.png","opindia.com/wp-content/uploads/2015/11/opindia-icon","img.etimg.com/photo/49057298.cms","akm-img-a-in.tosshub.com/indiatoday/news-update.jpg","uniindia.com//images/stripad.png"]},"./build/webtask/sync-stories.js":function(e,t,r){"use strict";r.r(t);r("./node_modules/core-js/modules/es6.array.sort.js");var o=r("rx"),s=r.n(o),i=r("requestretry"),n=r.n(i),l=r("./build/src/models/article.js"),a=r("./build/src/models/source.js"),u=r("./build/webtask/database.js"),c=r("./build/webtask/notifier.js"),d=r("./build/webtask/stories-provider.js");(e=e||{}).webtask=webtaskApi,global.document=r("jsdom").jsdom("<html></html>");class m{constructor(e,t,r){this.maxLimit=7,this.provider=e,this.db=t,this.result=r}updateResultFilter(e,t){t>0&&(this.result.filter||(this.result.filter={}),this.result.filter[e]=t)}syncStories(e,t){let r;return console.log("[syncer] syncStories:"+e.id),(r=t&&t.length>0?s.a.Observable.of({freshStories:t}):this.provider.getFreshStories(e)).flatMap(t=>{let r=t.freshStories,o=t.staleStoriesCount;return console.log(`[syncer] fetched ${r.length} ${e.id} stories from ${e.aggregator}`),this.result.fetch=r.length,r.length+o>0&&(this.result.fetch_stale_pc=Math.round(100*o/(r.length+o))),this.filterAndDecorate(e,r)}).flatMap(t=>{console.log(`[syncer] ${t.length} ${e.id} stories left after filterAndDecorate`),t.forEach(t=>this.dataPipeline(e,t));let r=t.filter(e=>e.title);return this.updateResultFilter("no_title",t.length-r.length),r=(t=r).filter(e=>e.urlToImage),this.updateResultFilter("no_image",t.length-r.length),r=(r=(t=r).filter(e=>e.description)).filter(e=>e.domain.match(/(twitter|youtube)/)||e.description.length>50),this.updateResultFilter("no_desc",t.length-r.length),console.log(`[syncer] ${r.length} ${e.id} stories finally left. Will store in db`),this.db.createStories(r).map(e=>(this.updateResultFilter("persistence_deduped",r.length-e.length),e))})}dataPipeline(e,t){t.url=this.normalizeUrlInner(t.url),this.detectLanguage(e,t),this.analyzeSentiment(e,t),this.decorateDedupeText(e,t),e.redirectSource&&(t.source=e.redirectSource),t.sourceCountry=e.country,t.sourceTopic=e.category,Object.keys(t).forEach(e=>{null!==t[e]&&void 0!==t[e]&&0!==t[e].length||delete t[e]})}decorateDedupeText(e,t){if("en"!==t.language)return;if(a.Source.isPrimaryImage(e)||a.Source.isPrimaryVideo(e))return;let o=r("compromise")(t.title+" "+t.description).nouns().normalize().unique().out("array");o=o.filter((e,t,r)=>r.indexOf(e)===t),t.dedupeText=o.sort().join(" ")}detectLanguage(e,t){if(e.multiLanguage&&!t.language){const e=r("franc-min"),o=r("langs");let s=e(t.title),i=o.where("3",s);t.language=i&&i[1]?i[1]:s,t.language&&(t.language=t.language.toLowerCase()),console.log(`[syncer] language detection: ${t.language} for '${t.title}'`)}t.language=t.language||e.language}analyzeSentiment(e,t){if("en"!=e.language)return;let o=r("vader-sentiment").SentimentIntensityAnalyzer.polarity_scores(t.title+"."+t.description).compound;"uplifting"==e.category&&(o+=.065),t.sentimentScore=100*o.toFixed(2)}normalizeUrlInner(e){const t=r("normalize-url");let o=l.Article.extractHostname(e);return t(e,{stripWWW:-1==m.WWW_NO_STRIP_DOMAINS.indexOf(o)})}filterAndDecorate(e,t){let r=a.Source.AGGREGATOR_SCRAPER==e.aggregator?10:5,o=(new Date).getTime()-864e5*r,i=t.map(e=>e.publishedAt?e.publishedAt.getTime():o),l=new Date(Math.min.apply(null,i)),u=t.map(e=>e.domain).filter((e,t,r)=>r.indexOf(e)===t);return t.forEach(e=>e.url=this.normalizeUrlInner(e.url)),this.db.getStoryUrls(l,u).flatMap(r=>{console.log(`[syncer] found ${r.length} stories since ${l}`);let o=t.filter(e=>r.indexOf(e.url)<0);return console.log(`[syncer] ${t.length-o.length}/${t.length} stories already exist`),this.updateResultFilter("already_exist",t.length-o.length),o.length>this.maxLimit&&(o=o.sort(()=>.5-Math.random()),this.updateResultFilter("limit_exceeded",o.length-this.maxLimit),this.result.pending_sync_stories=o.slice(this.maxLimit),o=o.slice(0,this.maxLimit)),s.a.Observable.from(o).mergeMap(t=>this.provider.getStoryDetails(e,t).catch(e=>{var r={method:"POST",uri:"https://hooks.slack.com/services/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",body:{text:`[syncer] ignoring the error transforming story ${t.source} ${t.url}: ${e}`},json:!0,fullResponse:!1,maxAttempts:1};return n()(r),console.log("[syncer] ignoring the error transforming story:",e),s.a.Observable.of(t)}),void 0,1).toArray()})}}if(m.WWW_NO_STRIP_DOMAINS=["indiatvnews.com","amarujala.com"],!global.rollbar){var g=r("rollbar");let e=new g({accessToken:"3e35f2012d1e4db083daa0c3151e639f",captureUncaught:!0,captureUnhandledRejections:!0});global.rollbar=e}e.exports=function(e,t){let r=e.body||{},o=r.source||e.query.source;if(!o)return t("please pass 'source'",null);g.configure({payload:{source:{id:o}}});let i=[];r.pendingSyncStories&&(i=r.pendingSyncStories.map(e=>l.Article.fromDumbJson(e))),e.storage.get((r,n)=>{if(r)return console.log("could not init storage:",r),t(r,null);{(n=n||{}).source2data=n.source2data||{};let r=new u.Database(e.secrets);r.getChannelById(o).subscribe(l=>{if(!l)return t(`source ${o} is invalid`,null);let u=a.Source.fromJson(l),g={aim:`fetch and sync ${u.id} stories from ${u.aggregator}`,start_time:new Date},p=new d.StoriesProvider(n,e.secrets);return new m(p,r,g).syncStories(u,i).flatMap(t=>{if(g.more_available||e.storage.set(n),console.log(`synced ${t.length} ${u.id} stories to db`),g.sync=t.length,g.sync_urls=t.map(e=>e.url),t.length>0){let s=t.sort((e,t)=>t.isPublishedAfter(e)?1:-1).filter(e=>!e.flag)[0].url;console.log("marking source as dirty");let i=u.redirectSource?u.redirectSource:o;return r.markChannelDirty(i,!0,s).subscribe(e=>console.log("dirty marking:",e)),new c.Notifier(e.secrets).sendNotification(u,t)}return s.a.Observable.of({})}).subscribe(e=>{null!=e&&null!=e.msg&&(console.log(`notified '${e.msg}' to ${e.recipients} customers`),g.notify_msg=e.msg,g.notify_count=e.recipients),g.duration=(new Date).getTime()-g.start_time.getTime()+"ms",t(null,g)},e=>{console.log("error:",e),t(e,null)})},e=>t(e,null))}})}},"./build/webtask/trends-provider.js":function(e,t,r){"use strict";r.r(t),r.d(t,"TrendsProvider",function(){return m});r("./node_modules/core-js/modules/es6.array.sort.js");var o=r("rx"),s=r.n(o),i=r("requestretry"),n=r.n(i),l=r("compromise"),a=r.n(l),u=r("fuzzball"),c=r.n(u),d=r("./build/src/models/trend.js");(e=e||{}).webtask=webtaskApi;class m{constructor(e,t){this.secrets=e,this.countryCode=t}buildHotTier(){let e=m.COUNTRY_TO_REGION[this.countryCode];return r("algoliasearch")(this.secrets[`algolia_app_id_${e}`],this.secrets[`algolia_admin_key_${e}`]).initIndex("stories")}topTrends(e){if(console.log(`[trends-provider] finding top ${e} trends for ${this.countryCode}`),"manual"==e)return this.topManualTrends();return m.COUNTRY_TO_REGION[this.countryCode]?"native"==e?this.topNativeTrends():"twitter"==e?this.topTwitterTrends():"google"==e?this.topGoogleTrends():(console.log("[trends-provider] Invalid source "+e),s.a.Observable.of([])):(console.log("[trends-provider] no region found. returning empty trends"),s.a.Observable.of([]))}decorateTrends(e){return s.a.Observable.from(e).concatMap(e=>this.decorateTrend(e)).toArray()}decorateTrend(e){this.hotTier||(this.hotTier=this.buildHotTier());let t=(new Date).getTime()-e.createdAt.getTime(),r="week";t<144e4?r="hour":t<1728e4&&(r="day"),e.horizon=r;let o=e.getHotTierSearchParams(),i={query:o.searchString,filters:o.filterString,hitsPerPage:30,attributesToRetrieve:["title","description"]};return o.extraParams&&Object.keys(o.extraParams).forEach(e=>i[e]=o.extraParams[e]),s.a.Observable.fromPromise(this.hotTier.search(i).then(t=>{let r=this.fuzzyRelevant(t.hits,e.refStoryList);return e.storyCount=r.length,e.features=this.buildStoryFeatures(r.slice(0,5)),console.log(`[trends-provider][decorateStoryCount][${new Date}] got `+`${e.storyCount} stories for ${e.source} trend '${e.term}'`),Promise.resolve(e)}))}fuzzyRelevant(e,t){let r={cutoff:30,scorer:c.a.token_set_ratio,keepmap:!0},o=e.map(e=>a()(e.title+" "+e.description).nouns().normalize().unique().out("text")),s=[];if(t&&t.length>0)t.forEach(e=>{let t=a()(e.title+" "+e.description).nouns().normalize().unique().out("text"),r=c.a.extract(t,o);r&&r.length>0&&(s=s.concat(r.map(e=>e[2])))}),s=s.filter((e,t,r)=>r.indexOf(e)===t);else{let e=c.a.dedupe(o,r);if(e&&e.length>0){let t=0,r=e[0][2].length;for(let o=1;o<e.length;o++)e[o][2].length>r&&(t=o,r=e[o][2].length);s=e[t][2].map(e=>e[2])}}return s.map(t=>e[t])}buildStoryFeatures(e){let t={};return e.forEach(e=>{let r=a()(e.title+" "+e.description).topics().normalize().unique().out("array");r&&(r=r.slice(0,100)).forEach(e=>{t[e]=t[e]?t[e]+1:1})}),Object.keys(t).forEach(e=>{!e.startsWith("http")&&t[e]<2&&delete t[e]}),t}topTwitterTrends(){let e=m.COUNTRY_TO_PLACE_ID[this.countryCode];if(!e)return s.a.Observable.of([]);var t=new(r("twit"))({consumer_key:this.secrets.twitter_consumer_key,consumer_secret:this.secrets.twitter_consumer_secret,app_only_auth:!0,timeout_ms:1e4});return s.a.Observable.fromPromise(t.get("trends/place",{id:e}).then(e=>{if(!(e=e.data)||!e.length)return console.log("[trends-provider] got null result from twitter:",e),Promise.resolve([]);let t=e[0].trends;return t=(t=t.filter(e=>!e.promoted_content&&!/[^\u0000-\u007f]/.test(e.name))).map(e=>{let t=e.name;return t.startsWith("#")&&(t=t.substring(1)),e.name=t.replace(/([A-Z])([A-Z])([a-z])|([a-z])([A-Z])/g,"$1$4 $2$3$5"),d.Trend.fromTwitterTrend(e,this.countryCode)}),Promise.resolve(t.slice(0,m.MAX_TRENDS_PER_SOURCE))}))}topGoogleTrends(){return this.topGoogleTrendsRaw().map(e=>e.slice(0,m.MAX_TRENDS_PER_SOURCE).filter(e=>!/[^\u0000-\u007f]/.test(e.title)).map(e=>d.Trend.fromGoogleTrend(e,this.countryCode)))}topGoogleTrendsRaw(){if("ww"==this.countryCode)return s.a.Observable.of([]);const e={method:"POST",uri:"https://trends.google.com/trends/hottrends/hotItems",form:{pn:m.COUNTRY_TO_GOOGLE_TRENDS_CODE[this.countryCode],htv:"l"},json:!0,fullResponse:!1,maxAttempts:1};return s.a.Observable.fromPromise(n()(e).then(e=>{if(!e.trendsByDateList)return Promise.resolve([]);let t=[];return e.trendsByDateList.slice(0,2).forEach(e=>t=t.concat(e.trendsList)),t=t.filter(e=>e.safe),Promise.resolve(t)}))}topManualTrends(){let e=m.TRENDING_TAGS_BY_COUNTRY[this.countryCode]||[];return e.forEach(e=>e.countryCode=this.countryCode),s.a.Observable.of(e.map(e=>d.Trend.fromJson(e)))}processNativeFacets(e,t,r,o){let s=[];return e.forEach(e=>{let i="entity";"_tags"!==e&&"tags"!==e||(i="tag"),t[e]=t[e]||{},r[e]=r[e]||{},o[e]=o[e]||{};let n=Object.keys(t[e]);n=n.filter(r=>t[e][r]>2);let l=Object.keys(r[e]),a=Object.keys(o[e]||[]),u=n.filter(e=>l.indexOf(e)<0);u=u.slice(0,m.NATIVE_TYPE_LIMITS[i].hour);let c=l.filter(e=>a.indexOf(e)<0);c=c.slice(0,m.NATIVE_TYPE_LIMITS[i].day),s=(s=s.concat(u.map(e=>d.Trend.fromJson({countryCode:this.countryCode,type:i,horizon:"hour",term:e,source:"native"})))).concat(c.map(e=>d.Trend.fromJson({countryCode:this.countryCode,type:i,horizon:"day",term:e,source:"native"})))}),console.log("[trends-provider] got native trends:",s),s}hotTierSearch(e,t,r){return this.hotTier||(this.hotTier=this.buildHotTier()),s.a.Observable.fromPromise(this.hotTier.search({filters:t,facets:e,maxValuesPerFacet:r,hitsPerPage:0}))}topNativeTrends(){let e=new Date,t=new Date(e.getTime()-1728e5),r=new Date(e.getTime()-144e5),o=["entities.commonname"];return this.hotTierSearch(o,`sourceCountry:${this.countryCode} AND createdAt > ${r.getTime()}`,10).flatMap(e=>{let r=e.facets;return console.log("[trends-provider] got hours facets:",r),this.hotTierSearch(o,`sourceCountry:${this.countryCode} AND createdAt > ${t.getTime()}`,20).flatMap(e=>{let s=e.facets;return console.log("[trends-provider] got days facets:",s),this.hotTierSearch(o,`sourceCountry:${this.countryCode} AND createdAt < ${t.getTime()}`,30).map(e=>{let t=e.facets;return console.log("[trends-provider] got weeks facets:",t),this.processNativeFacets(o,r,s,t)})})})}buildFeatureVector(e,t){let r=[],o=Object.keys(t).sort();for(let s=0;s<o.length;s++){let i=o[s],n=e.features[i];r[s]=n?(n/t[i]).toFixed(4):0}return r}buildFeatureDictionary(e){let t={};return e.forEach(e=>{let r=e.features,o=e.term.toLowerCase();r[o]=r[o]?r[o]+2:2,Object.keys(r).forEach(e=>{let o=r[e];t[e]=t[e]?t[e]+o:o})}),t}buildAnnoyIndex(e){var t=new(r("annoy"))(e[0].length,"Angular");for(let r=0;r<e.length;r++)t.addItem(r,e[r]);return t.build(),t}deDupeTrends(e){if(e.length<5)return e;e=e.filter(e=>"twitter"!==e.source||e.features&&Object.keys(e.features).length>=2);let t=this.buildFeatureDictionary(e),r=e.map(e=>this.buildFeatureVector(e,t)),o=this.buildAnnoyIndex(r);for(let t=0;t<r.length;t++){let r=o.getNNsByItem(t,5,-1,!0),s=[];for(let t=1;t<r.neighbors.length;t++){r.distances[t].toFixed(2)<1.3&&s.push(e[r.neighbors[t]].term)}e[t].relatedTerms=s}let s={},i=[];for(let t=0;t<e.length;t++)s[e[t].term]||(i.push(e[t]),e[t].relatedTerms.forEach(e=>s[e]=1));return i}}m.MAX_TRENDS_PER_SOURCE=35,m.COUNTRY_TO_PLACE_ID={in:23424848,us:23424977},m.COUNTRY_TO_GOOGLE_TRENDS_CODE={in:"p3",us:"p1"},m.COUNTRY_TO_REGION={in:"in",us:"us",ww:"us"},m.NATIVE_TYPE_LIMITS={entity:{hour:3,day:4},tag:{hour:2,day:3}},m.TRENDING_TAGS_BY_COUNTRY={in:[],us:[],ww:[]}},"./node_modules/core-js/modules/_a-function.js":function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},"./node_modules/core-js/modules/_an-object.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_is-object.js");e.exports=function(e){if(!o(e))throw TypeError(e+" is not an object!");return e}},"./node_modules/core-js/modules/_core.js":function(e,t){var r=e.exports={version:"2.5.7"};"number"==typeof __e&&(__e=r)},"./node_modules/core-js/modules/_ctx.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_a-function.js");e.exports=function(e,t,r){if(o(e),void 0===t)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,o){return e.call(t,r,o)};case 3:return function(r,o,s){return e.call(t,r,o,s)}}return function(){return e.apply(t,arguments)}}},"./node_modules/core-js/modules/_defined.js":function(e,t){e.exports=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e}},"./node_modules/core-js/modules/_descriptors.js":function(e,t,r){e.exports=!r("./node_modules/core-js/modules/_fails.js")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},"./node_modules/core-js/modules/_dom-create.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_is-object.js"),s=r("./node_modules/core-js/modules/_global.js").document,i=o(s)&&o(s.createElement);e.exports=function(e){return i?s.createElement(e):{}}},"./node_modules/core-js/modules/_export.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_global.js"),s=r("./node_modules/core-js/modules/_core.js"),i=r("./node_modules/core-js/modules/_hide.js"),n=r("./node_modules/core-js/modules/_redefine.js"),l=r("./node_modules/core-js/modules/_ctx.js"),a=function(e,t,r){var u,c,d,m,g=e&a.F,p=e&a.G,f=e&a.S,h=e&a.P,y=e&a.B,b=p?o:f?o[t]||(o[t]={}):(o[t]||{}).prototype,_=p?s:s[t]||(s[t]={}),T=_.prototype||(_.prototype={});for(u in p&&(r=t),r)d=((c=!g&&b&&void 0!==b[u])?b:r)[u],m=y&&c?l(d,o):h&&"function"==typeof d?l(Function.call,d):d,b&&n(b,u,d,e&a.U),_[u]!=d&&i(_,u,m),h&&T[u]!=d&&(T[u]=d)};o.core=s,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,e.exports=a},"./node_modules/core-js/modules/_fails.js":function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},"./node_modules/core-js/modules/_global.js":function(e,t){var r=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},"./node_modules/core-js/modules/_has.js":function(e,t){var r={}.hasOwnProperty;e.exports=function(e,t){return r.call(e,t)}},"./node_modules/core-js/modules/_hide.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_object-dp.js"),s=r("./node_modules/core-js/modules/_property-desc.js");e.exports=r("./node_modules/core-js/modules/_descriptors.js")?function(e,t,r){return o.f(e,t,s(1,r))}:function(e,t,r){return e[t]=r,e}},"./node_modules/core-js/modules/_ie8-dom-define.js":function(e,t,r){e.exports=!r("./node_modules/core-js/modules/_descriptors.js")&&!r("./node_modules/core-js/modules/_fails.js")(function(){return 7!=Object.defineProperty(r("./node_modules/core-js/modules/_dom-create.js")("div"),"a",{get:function(){return 7}}).a})},"./node_modules/core-js/modules/_is-object.js":function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},"./node_modules/core-js/modules/_object-dp.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_an-object.js"),s=r("./node_modules/core-js/modules/_ie8-dom-define.js"),i=r("./node_modules/core-js/modules/_to-primitive.js"),n=Object.defineProperty;t.f=r("./node_modules/core-js/modules/_descriptors.js")?Object.defineProperty:function(e,t,r){if(o(e),t=i(t,!0),o(r),s)try{return n(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(e[t]=r.value),e}},"./node_modules/core-js/modules/_property-desc.js":function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},"./node_modules/core-js/modules/_redefine.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_global.js"),s=r("./node_modules/core-js/modules/_hide.js"),i=r("./node_modules/core-js/modules/_has.js"),n=r("./node_modules/core-js/modules/_uid.js")("src"),l=Function.toString,a=(""+l).split("toString");r("./node_modules/core-js/modules/_core.js").inspectSource=function(e){return l.call(e)},(e.exports=function(e,t,r,l){var u="function"==typeof r;u&&(i(r,"name")||s(r,"name",t)),e[t]!==r&&(u&&(i(r,n)||s(r,n,e[t]?""+e[t]:a.join(String(t)))),e===o?e[t]=r:l?e[t]?e[t]=r:s(e,t,r):(delete e[t],s(e,t,r)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[n]||l.call(this)})},"./node_modules/core-js/modules/_strict-method.js":function(e,t,r){"use strict";var o=r("./node_modules/core-js/modules/_fails.js");e.exports=function(e,t){return!!e&&o(function(){t?e.call(null,function(){},1):e.call(null)})}},"./node_modules/core-js/modules/_to-object.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_defined.js");e.exports=function(e){return Object(o(e))}},"./node_modules/core-js/modules/_to-primitive.js":function(e,t,r){var o=r("./node_modules/core-js/modules/_is-object.js");e.exports=function(e,t){if(!o(e))return e;var r,s;if(t&&"function"==typeof(r=e.toString)&&!o(s=r.call(e)))return s;if("function"==typeof(r=e.valueOf)&&!o(s=r.call(e)))return s;if(!t&&"function"==typeof(r=e.toString)&&!o(s=r.call(e)))return s;throw TypeError("Can't convert object to primitive value")}},"./node_modules/core-js/modules/_uid.js":function(e,t){var r=0,o=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++r+o).toString(36))}},"./node_modules/core-js/modules/es6.array.sort.js":function(e,t,r){"use strict";var o=r("./node_modules/core-js/modules/_export.js"),s=r("./node_modules/core-js/modules/_a-function.js"),i=r("./node_modules/core-js/modules/_to-object.js"),n=r("./node_modules/core-js/modules/_fails.js"),l=[].sort,a=[1,2,3];o(o.P+o.F*(n(function(){a.sort(void 0)})||!n(function(){a.sort(null)})||!r("./node_modules/core-js/modules/_strict-method.js")(l)),"Array",{sort:function(e){return void 0===e?l.call(i(this)):l.call(i(this),s(e))}})},algoliasearch:function(e,t){e.exports=require("algoliasearch")},annoy:function(e,t){e.exports=require("annoy")},cloudscraper:function(e,t){e.exports=require("cloudscraper")},compromise:function(e,t){e.exports=require("compromise")},"franc-min":function(e,t){e.exports=require("franc-min")},fuzzball:function(e,t){e.exports=require("fuzzball")},jsdom:function(e,t){e.exports=require("jsdom")},langs:function(e,t){e.exports=require("langs")},mongodb:function(e,t){e.exports=require("mongodb")},"normalize-url":function(e,t){e.exports=require("normalize-url")},requestretry:function(e,t){e.exports=require("requestretry")},rollbar:function(e,t){e.exports=require("rollbar")},rx:function(e,t){e.exports=require("rx")},twit:function(e,t){e.exports=require("twit")},unfluff:function(e,t){e.exports=require("unfluff")},"vader-sentiment":function(e,t){e.exports=require("vader-sentiment")}});